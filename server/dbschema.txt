-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.allergies (
  allergy_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  patient_id uuid NOT NULL,
  allergen character varying,
  reaction_type character varying,
  severity character varying CHECK (severity::text = ANY (ARRAY['mild'::character varying, 'moderate'::character varying, 'severe'::character varying, 'life_threatening'::character varying]::text[])),
  date_identified date,
  notes text,
  recorded_by uuid,
  recorded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT allergies_pkey PRIMARY KEY (allergy_id),
  CONSTRAINT allergies_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT allergies_recorded_by_fkey FOREIGN KEY (recorded_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.anthropometric_measurements (
  am_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  patient_id uuid NOT NULL,
  weight numeric,
  height numeric,
  head_circumference numeric,
  chest_circumference numeric,
  abdominal_circumference numeric,
  measurement_date date DEFAULT CURRENT_DATE CHECK (measurement_date <= CURRENT_DATE),
  recorded_by uuid,
  recorded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT anthropometric_measurements_pkey PRIMARY KEY (am_id),
  CONSTRAINT anthropometric_measurements_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT anthropometric_measurements_recorded_by_fkey FOREIGN KEY (recorded_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.appointments (
  appointment_id bigint NOT NULL DEFAULT nextval('appointments_appointment_id_seq'::regclass),
  patient_id uuid,
  facility_id uuid NOT NULL,
  doctor_id uuid,
  scheduled_by uuid NOT NULL,
  appointment_date timestamp with time zone NOT NULL,
  status character varying DEFAULT 'scheduled'::character varying CHECK (status::text = ANY (ARRAY['scheduled'::character varying::text, 'confirmed'::character varying::text, 'cancelled'::character varying::text, 'completed'::character varying::text, 'no_show'::character varying::text, 'in_progress'::character varying::text, 'checked_in'::character varying::text])),
  reason text,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  updated_by uuid,
  appointment_time time without time zone,
  patient_name text,
  doctor_name text DEFAULT 'Any Available Doctor'::text,
  appointment_type character varying DEFAULT 'consultation'::character varying CHECK (appointment_type::text = ANY (ARRAY['consultation'::character varying, 'followup'::character varying, 'emergency'::character varying, 'checkup'::character varying, 'vaccination'::character varying]::text[])),
  created_by uuid,
  CONSTRAINT appointments_pkey PRIMARY KEY (appointment_id),
  CONSTRAINT appointments_doctor_id_fkey FOREIGN KEY (doctor_id) REFERENCES public.users(user_id),
  CONSTRAINT appointments_scheduled_by_fkey FOREIGN KEY (scheduled_by) REFERENCES public.users(user_id),
  CONSTRAINT appointments_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT appointments_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id),
  CONSTRAINT appointments_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.users(user_id),
  CONSTRAINT appointments_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.audit_logs (
  log_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  action_type character varying NOT NULL CHECK (action_type::text = ANY (ARRAY['CREATE'::character varying, 'UPDATE'::character varying, 'DELETE'::character varying, 'VIEW'::character varying, 'DENIED'::character varying]::text[])),
  table_name character varying NOT NULL,
  record_id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid,
  action_timestamp timestamp with time zone NOT NULL DEFAULT now(),
  ip_address inet,
  old_values jsonb,
  new_values jsonb,
  session_id text,
  qr_id uuid,
  CONSTRAINT audit_logs_pkey PRIMARY KEY (log_id),
  CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT audit_logs_qr_id_fkey FOREIGN KEY (qr_id) REFERENCES public.qr_codes(qr_id)
);
CREATE TABLE public.consent_audit_logs (
  log_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  consent_id uuid,
  qr_id uuid,
  patient_id uuid,
  parent_id uuid,
  action character varying NOT NULL CHECK (action::text = ANY (ARRAY['consent_granted'::character varying, 'consent_revoked'::character varying, 'consent_modified'::character varying, 'consent_expired'::character varying, 'qr_generated'::character varying, 'qr_accessed'::character varying, 'qr_revoked'::character varying, 'qr_expired'::character varying, 'preferences_updated'::character varying, 'emergency_revoke_all'::character varying, 'access_attempt_blocked'::character varying, 'suspicious_activity_detected'::character varying]::text[])),
  performed_by uuid,
  performed_at timestamp with time zone NOT NULL DEFAULT now(),
  details jsonb DEFAULT '{}'::jsonb,
  ip_address inet,
  user_agent text,
  success boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT consent_audit_logs_pkey PRIMARY KEY (log_id),
  CONSTRAINT consent_audit_logs_qr_id_fkey FOREIGN KEY (qr_id) REFERENCES public.qr_codes(qr_id),
  CONSTRAINT consent_audit_logs_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT consent_audit_logs_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.users(user_id),
  CONSTRAINT consent_audit_logs_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.consent_preferences (
  preference_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  parent_id uuid NOT NULL UNIQUE,
  default_expiry_days integer NOT NULL DEFAULT 7 CHECK (default_expiry_days >= 1 AND default_expiry_days <= 365),
  default_max_uses integer NOT NULL DEFAULT 10 CHECK (default_max_uses >= 1 AND default_max_uses <= 100),
  default_scope jsonb NOT NULL DEFAULT '["view_only", "allergies", "vaccinations"]'::jsonb,
  always_require_pin boolean NOT NULL DEFAULT false,
  notify_on_access boolean NOT NULL DEFAULT true,
  notify_on_expiry boolean NOT NULL DEFAULT true,
  notify_before_expiry_days integer NOT NULL DEFAULT 3 CHECK (notify_before_expiry_days >= 1 AND notify_before_expiry_days <= 30),
  allow_emergency_override boolean NOT NULL DEFAULT false,
  emergency_contact_notified boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT consent_preferences_pkey PRIMARY KEY (preference_id),
  CONSTRAINT consent_preferences_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.consultation_types (
  type_id smallint GENERATED ALWAYS AS IDENTITY NOT NULL,
  type_name character varying NOT NULL,
  description text,
  CONSTRAINT consultation_types_pkey PRIMARY KEY (type_id)
);
CREATE TABLE public.delivery_record (
  delivery_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  patient_id uuid,
  type_of_delivery character varying,
  apgar_score numeric CHECK (apgar_score >= 0::numeric AND apgar_score <= 10::numeric),
  mother_blood_type character varying,
  father_blood_type character varying,
  patient_blood_type character varying,
  distinguishable_marks text,
  vitamin_k_date date,
  vitamin_k_location character varying,
  hepatitis_b_date date,
  hepatitis_b_location character varying,
  bcg_vaccination_date date,
  bcg_vaccination_location character varying,
  other_medications text,
  discharge_diagnosis text,
  follow_up_visit_date date,
  follow_up_visit_site character varying,
  obstetrician text,
  pediatrician text,
  recorded_by uuid,
  CONSTRAINT delivery_record_pkey PRIMARY KEY (delivery_id),
  CONSTRAINT delivery_record_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT delivery_record_recorded_by_fkey FOREIGN KEY (recorded_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.email_change_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  current_email text NOT NULL,
  new_email text NOT NULL,
  verification_code character varying NOT NULL,
  code_expires_at timestamp with time zone NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_change_requests_pkey PRIMARY KEY (id),
  CONSTRAINT email_change_requests_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.email_notifications (
  notification_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  facility_id uuid,
  recipient_email character varying NOT NULL,
  notification_type character varying NOT NULL CHECK (notification_type::text = ANY (ARRAY['invoice_generated'::character varying, 'payment_reminder'::character varying, 'payment_received'::character varying, 'subscription_expiring'::character varying, 'subscription_expired'::character varying, 'subscription_upgraded'::character varying, 'subscription_downgraded'::character varying, 'subscription_cancelled'::character varying]::text[])),
  subject character varying NOT NULL,
  body_text text NOT NULL,
  body_html text,
  status character varying DEFAULT 'queued'::character varying CHECK (status::text = ANY (ARRAY['queued'::character varying, 'sent'::character varying, 'failed'::character varying, 'bounced'::character varying]::text[])),
  sent_at timestamp with time zone,
  error_message text,
  retry_count integer DEFAULT 0,
  metadata jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT email_notifications_pkey PRIMARY KEY (notification_id),
  CONSTRAINT email_notifications_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id)
);
CREATE TABLE public.facility_patients (
  facility_patient_id uuid NOT NULL DEFAULT gen_random_uuid(),
  facility_id uuid NOT NULL,
  patient_id uuid NOT NULL,
  registered_at timestamp with time zone DEFAULT now(),
  registered_by uuid,
  registration_method character varying DEFAULT 'manual'::character varying,
  qr_code_scanned_at timestamp with time zone,
  qr_code_scanned_by uuid,
  is_active boolean DEFAULT true,
  deactivated_at timestamp with time zone,
  deactivated_by uuid,
  deactivation_reason text,
  facility_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT facility_patients_pkey PRIMARY KEY (facility_patient_id),
  CONSTRAINT facility_patients_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id),
  CONSTRAINT facility_patients_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT facility_patients_registered_by_fkey FOREIGN KEY (registered_by) REFERENCES public.users(user_id),
  CONSTRAINT facility_patients_qr_code_scanned_by_fkey FOREIGN KEY (qr_code_scanned_by) REFERENCES public.users(user_id),
  CONSTRAINT facility_patients_deactivated_by_fkey FOREIGN KEY (deactivated_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.facility_users (
  facility_id uuid NOT NULL,
  user_id uuid NOT NULL,
  role character varying NOT NULL CHECK (role::text = ANY (ARRAY['doctor'::character varying::text, 'nurse'::character varying::text, 'admin'::character varying::text, 'staff'::character varying::text, 'facility_admin'::character varying::text])),
  start_date date DEFAULT CURRENT_DATE,
  end_date date,
  assigned_by uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  department character varying CHECK (department IS NULL OR (department::text = ANY (ARRAY['Pediatrics'::character varying, 'Cardiology'::character varying, 'Emergency'::character varying, 'Surgery'::character varying, 'Administration'::character varying, 'Radiology'::character varying, 'Laboratory'::character varying, 'Pharmacy'::character varying, 'Nursing'::character varying, 'IT'::character varying, 'Human Resources'::character varying, 'Finance'::character varying]::text[]))),
  CONSTRAINT facility_users_pkey PRIMARY KEY (facility_id, user_id),
  CONSTRAINT facility_users_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id),
  CONSTRAINT facility_users_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT facility_users_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.feedback (
  feedback_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  user_role character varying,
  feedback_type character varying NOT NULL CHECK (feedback_type::text = ANY (ARRAY['bug_report'::character varying, 'feature_suggestion'::character varying, 'general_feedback'::character varying, 'question'::character varying]::text[])),
  category character varying,
  subject character varying NOT NULL,
  message text NOT NULL,
  is_anonymous boolean DEFAULT false,
  status character varying DEFAULT 'submitted'::character varying CHECK (status::text = ANY (ARRAY['submitted'::character varying, 'under_review'::character varying, 'in_progress'::character varying, 'resolved'::character varying, 'closed'::character varying]::text[])),
  admin_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT feedback_pkey PRIMARY KEY (feedback_id),
  CONSTRAINT feedback_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.growth_milestones (
  milestone_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  patient_id uuid NOT NULL,
  milestone_type character varying NOT NULL,
  milestone_date date NOT NULL,
  description text,
  notes text,
  recorded_by uuid NOT NULL,
  recorded_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT growth_milestones_pkey PRIMARY KEY (milestone_id),
  CONSTRAINT growth_milestones_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT growth_milestones_recorded_by_fkey FOREIGN KEY (recorded_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.healthcare_facilities (
  facility_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  facility_name character varying NOT NULL,
  address text NOT NULL,
  city character varying NOT NULL,
  zip_code character varying NOT NULL,
  contact_number character varying NOT NULL,
  email character varying NOT NULL,
  website character varying,
  subscription_status character varying DEFAULT 'active'::character varying CHECK (subscription_status::text = ANY (ARRAY['active'::character varying, 'inactive'::character varying, 'suspended'::character varying]::text[])),
  subscription_expires date,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid NOT NULL,
  type text NOT NULL DEFAULT 'clinic'::text,
  plan text NOT NULL DEFAULT 'standard'::text,
  deleted_at timestamp with time zone,
  logo_url text,
  CONSTRAINT healthcare_facilities_pkey PRIMARY KEY (facility_id),
  CONSTRAINT healthcare_facilities_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.invoices (
  invoice_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  facility_id uuid NOT NULL,
  invoice_number character varying NOT NULL UNIQUE,
  billing_period_start date NOT NULL,
  billing_period_end date NOT NULL,
  issue_date date NOT NULL DEFAULT CURRENT_DATE,
  due_date date NOT NULL,
  subtotal numeric NOT NULL CHECK (subtotal >= 0::numeric),
  tax_amount numeric DEFAULT 0 CHECK (tax_amount >= 0::numeric),
  total_amount numeric NOT NULL CHECK (total_amount >= 0::numeric),
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'paid'::character varying, 'overdue'::character varying, 'cancelled'::character varying, 'refunded'::character varying]::text[])),
  plan_type character varying NOT NULL,
  payment_method character varying CHECK (payment_method::text = ANY (ARRAY['manual'::character varying, 'bank_transfer'::character varying, 'check'::character varying, 'other'::character varying]::text[])),
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid NOT NULL,
  paid_at timestamp with time zone,
  cancelled_at timestamp with time zone,
  CONSTRAINT invoices_pkey PRIMARY KEY (invoice_id),
  CONSTRAINT invoices_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id),
  CONSTRAINT invoices_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.medical_documents (
  document_id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  facility_id uuid NOT NULL,
  document_type character varying NOT NULL CHECK (document_type::text = ANY (ARRAY['lab_result'::character varying, 'imaging_report'::character varying, 'vaccination_record'::character varying, 'prescription'::character varying, 'other'::character varying]::text[])),
  document_name character varying NOT NULL,
  description text,
  storage_bucket character varying NOT NULL DEFAULT 'medical-documents'::character varying,
  storage_path text NOT NULL UNIQUE CHECK (length(storage_path) > 0),
  file_size bigint CHECK (file_size > 0 AND file_size <= 10485760),
  mime_type character varying,
  version integer NOT NULL DEFAULT 1 CHECK (version > 0),
  parent_document_id uuid,
  is_current_version boolean DEFAULT true,
  uploaded_by uuid NOT NULL,
  uploaded_at timestamp with time zone NOT NULL DEFAULT now(),
  related_appointment_id bigint,
  related_prescription_id uuid,
  related_vaccination_id uuid,
  deleted_at timestamp with time zone,
  deleted_by uuid,
  is_deleted boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  uploaded_by_role character varying,
  CONSTRAINT medical_documents_pkey PRIMARY KEY (document_id),
  CONSTRAINT medical_documents_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT medical_documents_parent_document_id_fkey FOREIGN KEY (parent_document_id) REFERENCES public.medical_documents(document_id),
  CONSTRAINT medical_documents_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.users(user_id),
  CONSTRAINT medical_documents_deleted_by_fkey FOREIGN KEY (deleted_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.medical_visits (
  visit_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  patient_id uuid NOT NULL,
  facility_id uuid NOT NULL,
  doctor_id uuid NOT NULL,
  visit_date date NOT NULL,
  visit_type text NOT NULL,
  diagnosis text,
  treatment_plan text,
  follow_up_date timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid NOT NULL,
  updated_at timestamp with time zone DEFAULT now(),
  updated_by uuid,
  CONSTRAINT medical_visits_pkey PRIMARY KEY (visit_id),
  CONSTRAINT medical_visits_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT medical_visits_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id),
  CONSTRAINT medical_visits_doctor_id_fkey FOREIGN KEY (doctor_id) REFERENCES public.users(user_id),
  CONSTRAINT medical_visits_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id),
  CONSTRAINT medical_visits_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.notification_preferences (
  preference_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL UNIQUE,
  appointment_reminder_enabled boolean DEFAULT true,
  upcoming_appointment_enabled boolean DEFAULT true,
  vaccination_due_enabled boolean DEFAULT true,
  qr_access_alert_enabled boolean DEFAULT true,
  system_announcement_enabled boolean DEFAULT true,
  sound_enabled boolean DEFAULT true,
  sound_type character varying DEFAULT 'default'::character varying CHECK (sound_type::text = ANY (ARRAY['default'::character varying, 'chime'::character varying, 'bell'::character varying, 'ding'::character varying, 'ping'::character varying, 'pop'::character varying, 'custom'::character varying]::text[])),
  custom_sound_url text,
  appointment_reminder_time integer DEFAULT 60 CHECK (appointment_reminder_time > 0),
  vaccination_reminder_days integer DEFAULT 7 CHECK (vaccination_reminder_days > 0),
  desktop_notifications boolean DEFAULT true,
  email_notifications boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  record_update_enabled boolean DEFAULT true,
  new_prescription_enabled boolean DEFAULT true,
  appointment_status_change_enabled boolean DEFAULT true,
  document_upload_enabled boolean DEFAULT true,
  allergy_alert_enabled boolean DEFAULT true,
  quiet_hours_enabled boolean DEFAULT false,
  quiet_hours_start time without time zone DEFAULT '22:00:00'::time without time zone,
  quiet_hours_end time without time zone DEFAULT '07:00:00'::time without time zone,
  priority_filter_enabled boolean DEFAULT false,
  minimum_priority character varying DEFAULT 'normal'::character varying CHECK (minimum_priority::text = ANY (ARRAY['urgent'::character varying, 'high'::character varying, 'normal'::character varying, 'low'::character varying]::text[])),
  notification_grouping_enabled boolean DEFAULT true,
  grouping_interval_minutes integer DEFAULT 15 CHECK (grouping_interval_minutes > 0 AND grouping_interval_minutes <= 120),
  CONSTRAINT notification_preferences_pkey PRIMARY KEY (preference_id),
  CONSTRAINT notification_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.notifications (
  notification_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  facility_id uuid,
  notification_type character varying NOT NULL CHECK (notification_type::text = ANY (ARRAY['appointment_reminder'::character varying, 'upcoming_appointment'::character varying, 'vaccination_due'::character varying, 'qr_access_alert'::character varying, 'system_announcement'::character varying]::text[])),
  title character varying NOT NULL,
  message text NOT NULL,
  priority character varying DEFAULT 'normal'::character varying CHECK (priority::text = ANY (ARRAY['low'::character varying, 'normal'::character varying, 'high'::character varying, 'urgent'::character varying]::text[])),
  is_read boolean DEFAULT false,
  is_archived boolean DEFAULT false,
  action_url text,
  metadata jsonb DEFAULT '{}'::jsonb,
  related_appointment_id bigint,
  related_patient_id uuid,
  related_qr_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  read_at timestamp with time zone,
  archived_at timestamp with time zone,
  expires_at timestamp with time zone,
  created_by uuid,
  CONSTRAINT notifications_pkey PRIMARY KEY (notification_id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT notifications_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id),
  CONSTRAINT notifications_related_appointment_id_fkey FOREIGN KEY (related_appointment_id) REFERENCES public.appointments(appointment_id),
  CONSTRAINT notifications_related_patient_id_fkey FOREIGN KEY (related_patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT notifications_related_qr_id_fkey FOREIGN KEY (related_qr_id) REFERENCES public.qr_codes(qr_id),
  CONSTRAINT notifications_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.parent_access (
  access_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  patient_id uuid NOT NULL,
  user_id uuid NOT NULL,
  relationship character varying CHECK (relationship::text = ANY (ARRAY['parent'::character varying, 'guardian'::character varying, 'caregiver'::character varying, 'family_member'::character varying]::text[])),
  granted_by uuid,
  granted_at date DEFAULT CURRENT_DATE,
  revoked_at date,
  is_active boolean NOT NULL DEFAULT true,
  assigned_by uuid,
  CONSTRAINT parent_access_pkey PRIMARY KEY (access_id),
  CONSTRAINT parent_access_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT parent_access_granted_by_fkey FOREIGN KEY (granted_by) REFERENCES public.users(user_id),
  CONSTRAINT parent_access_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT parent_access_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.patients (
  patient_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  firstname character varying NOT NULL,
  lastname character varying NOT NULL,
  date_of_birth date NOT NULL,
  sex character varying NOT NULL CHECK (sex::text = ANY (ARRAY['male'::character varying, 'female'::character varying, 'other'::character varying]::text[])),
  birth_weight numeric,
  birth_height numeric,
  bloodtype character varying,
  gestation_weeks smallint CHECK (gestation_weeks > 0 AND gestation_weeks <= 50),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_active boolean NOT NULL DEFAULT true,
  created_by uuid NOT NULL,
  middlename text,
  CONSTRAINT patients_pkey PRIMARY KEY (patient_id),
  CONSTRAINT patients_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.payment_transactions (
  transaction_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  invoice_id uuid NOT NULL,
  facility_id uuid NOT NULL,
  transaction_date timestamp with time zone NOT NULL DEFAULT now(),
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  payment_method character varying NOT NULL CHECK (payment_method::text = ANY (ARRAY['manual'::character varying, 'bank_transfer'::character varying, 'check'::character varying, 'cash'::character varying, 'other'::character varying]::text[])),
  transaction_reference character varying,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'completed'::character varying, 'failed'::character varying, 'refunded'::character varying]::text[])),
  notes text,
  processed_by uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_transactions_pkey PRIMARY KEY (transaction_id),
  CONSTRAINT payment_transactions_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES public.invoices(invoice_id),
  CONSTRAINT payment_transactions_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id),
  CONSTRAINT payment_transactions_processed_by_fkey FOREIGN KEY (processed_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.prescription_medications (
  pm_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  rx_id uuid NOT NULL,
  medication_name character varying NOT NULL,
  dosage character varying NOT NULL,
  frequency character varying NOT NULL,
  duration character varying,
  quantity character varying,
  refills_authorized smallint DEFAULT 0 CHECK (refills_authorized >= 0),
  special_instructions text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT prescription_medications_pkey PRIMARY KEY (pm_id),
  CONSTRAINT prescription_medications_rx_id_fkey FOREIGN KEY (rx_id) REFERENCES public.prescriptions(rx_id)
);
CREATE TABLE public.prescriptions (
  rx_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  patient_id uuid NOT NULL,
  visit_id uuid,
  doctor_id uuid NOT NULL,
  facility_id uuid NOT NULL,
  consultation_type smallint NOT NULL CHECK (consultation_type >= 1 AND consultation_type <= 10),
  prescription_date date NOT NULL DEFAULT CURRENT_DATE,
  patient_age_at_time text NOT NULL,
  findings text NOT NULL,
  consultation_notes text,
  doctor_instructions text NOT NULL,
  return_date date,
  status character varying DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying::text, 'completed'::character varying::text, 'cancelled'::character varying::text, 'expired'::character varying::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid NOT NULL,
  updated_by uuid,
  qr_share_count integer DEFAULT 0,
  last_shared_at timestamp with time zone,
  CONSTRAINT prescriptions_pkey PRIMARY KEY (rx_id),
  CONSTRAINT prescriptions_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT prescriptions_visit_id_fkey FOREIGN KEY (visit_id) REFERENCES public.medical_visits(visit_id),
  CONSTRAINT prescriptions_doctor_id_fkey FOREIGN KEY (doctor_id) REFERENCES public.users(user_id),
  CONSTRAINT prescriptions_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id),
  CONSTRAINT prescriptions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id),
  CONSTRAINT prescriptions_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.users(user_id),
  CONSTRAINT prescriptions_consultation_type_fkey FOREIGN KEY (consultation_type) REFERENCES public.consultation_types(type_id)
);
CREATE TABLE public.qr_access_logs (
  log_id uuid NOT NULL DEFAULT gen_random_uuid(),
  qr_id uuid NOT NULL,
  patient_id uuid NOT NULL,
  accessed_by uuid NOT NULL,
  accessed_at timestamp with time zone DEFAULT now(),
  facility_id uuid,
  access_method text DEFAULT 'qr_scan'::text,
  ip_address inet,
  user_agent text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT qr_access_logs_pkey PRIMARY KEY (log_id),
  CONSTRAINT qr_access_logs_qr_id_fkey FOREIGN KEY (qr_id) REFERENCES public.qr_codes(qr_id),
  CONSTRAINT qr_access_logs_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT qr_access_logs_accessed_by_fkey FOREIGN KEY (accessed_by) REFERENCES public.users(user_id),
  CONSTRAINT qr_access_logs_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id)
);
CREATE TABLE public.qr_codes (
  qr_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  token_hash character varying NOT NULL UNIQUE,
  patient_id uuid NOT NULL,
  generated_by uuid NOT NULL,
  facility_id uuid NOT NULL,
  share_type character varying NOT NULL DEFAULT 'medical_record'::character varying,
  scope jsonb NOT NULL DEFAULT '["view_only"]'::jsonb,
  expires_at timestamp with time zone NOT NULL,
  max_uses integer DEFAULT 1,
  use_count integer DEFAULT 0,
  pin_code character varying,
  target_facilities ARRAY,
  metadata jsonb DEFAULT '{}'::jsonb,
  last_accessed_at timestamp with time zone,
  last_accessed_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  CONSTRAINT qr_codes_pkey PRIMARY KEY (qr_id),
  CONSTRAINT qr_codes_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT qr_codes_generated_by_fkey FOREIGN KEY (generated_by) REFERENCES public.users(user_id),
  CONSTRAINT qr_codes_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id),
  CONSTRAINT qr_codes_last_accessed_by_fkey FOREIGN KEY (last_accessed_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.screening_tests (
  st_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  patient_id uuid NOT NULL,
  ens_date date,
  ens_remarks boolean,
  nhs_date date,
  nhs_right_ear boolean,
  nhs_left_ear boolean,
  pos_date date,
  pos_for_cchd_right boolean,
  pos_for_cchd_left boolean,
  ror_date date,
  ror_remarks character varying,
  created_at timestamp with time zone DEFAULT now(),
  recorded_by uuid,
  CONSTRAINT screening_tests_pkey PRIMARY KEY (st_id),
  CONSTRAINT screening_tests_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT screening_tests_recorded_by_fkey FOREIGN KEY (recorded_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.subscription_history (
  history_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  facility_id uuid NOT NULL,
  previous_plan character varying,
  new_plan character varying NOT NULL,
  previous_status character varying,
  new_status character varying NOT NULL,
  change_type character varying NOT NULL CHECK (change_type::text = ANY (ARRAY['upgrade'::character varying, 'downgrade'::character varying, 'renewal'::character varying, 'cancellation'::character varying, 'reactivation'::character varying, 'status_change'::character varying]::text[])),
  effective_date date NOT NULL DEFAULT CURRENT_DATE,
  previous_expires date,
  new_expires date,
  changed_by uuid NOT NULL,
  change_reason text,
  metadata jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT subscription_history_pkey PRIMARY KEY (history_id),
  CONSTRAINT subscription_history_facility_id_fkey FOREIGN KEY (facility_id) REFERENCES public.healthcare_facilities(facility_id),
  CONSTRAINT subscription_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.system_announcements (
  announcement_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  title character varying NOT NULL,
  message text NOT NULL,
  priority character varying DEFAULT 'normal'::character varying CHECK (priority::text = ANY (ARRAY['low'::character varying, 'normal'::character varying, 'high'::character varying, 'urgent'::character varying]::text[])),
  target_roles ARRAY DEFAULT ARRAY['doctor'::text, 'facility_admin'::text, 'system_admin'::text],
  target_facilities ARRAY,
  published_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone,
  created_by uuid,
  is_active boolean DEFAULT true,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT system_announcements_pkey PRIMARY KEY (announcement_id),
  CONSTRAINT system_announcements_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.user_2fa_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  is_enabled boolean DEFAULT false,
  method character varying DEFAULT 'email'::character varying CHECK (method::text = ANY (ARRAY['email'::character varying, 'sms'::character varying]::text[])),
  verification_code character varying,
  code_expires_at timestamp with time zone,
  verified_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_2fa_settings_pkey PRIMARY KEY (id),
  CONSTRAINT user_2fa_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.users (
  user_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  email character varying NOT NULL UNIQUE,
  password text NOT NULL,
  firstname character varying NOT NULL,
  lastname character varying NOT NULL,
  role character varying NOT NULL CHECK (role::text = ANY (ARRAY['doctor'::character varying::text, 'nurse'::character varying::text, 'admin'::character varying::text, 'facility_admin'::character varying::text, 'parent'::character varying::text, 'guardian'::character varying::text, 'staff'::character varying::text])),
  specialty character varying,
  license_number character varying,
  phone_number character varying,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  is_active boolean DEFAULT false,
  is_subscribed boolean DEFAULT false,
  subscription_expires date CHECK (subscription_expires IS NULL OR subscription_expires > '2020-01-01'::date),
  last_sign_in_at timestamp with time zone,
  employee_id_number text,
  middlename character varying,
  years_of_experience text,
  education text,
  certifications text,
  job_title character varying,
  relationship_to_patient character varying CHECK (relationship_to_patient IS NULL OR (relationship_to_patient::text = ANY (ARRAY['mother'::character varying, 'father'::character varying, 'legal_guardian'::character varying, 'grandparent'::character varying, 'other'::character varying]::text[]))),
  address text,
  emergency_contact_name character varying,
  emergency_contact_phone character varying,
  CONSTRAINT users_pkey PRIMARY KEY (user_id)
);
CREATE TABLE public.vaccinations (
  vax_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  patient_id uuid NOT NULL,
  visit_id uuid,
  vaccine_name character varying,
  dose_number smallint CHECK (dose_number > 0),
  administered_date timestamp with time zone,
  administered_by uuid,
  manufacturer character varying,
  lot_number character varying,
  administration_site character varying,
  next_dose_due date,
  notes text,
  recorded_at timestamp with time zone DEFAULT now(),
  deleted_at timestamp with time zone,
  deleted_by uuid,
  is_deleted boolean NOT NULL DEFAULT false,
  recorded_by uuid,
  route_of_administration character varying CHECK (route_of_administration IS NULL OR (route_of_administration::text = ANY (ARRAY['Intramuscular (IM)'::character varying, 'Subcutaneous (SC)'::character varying, 'Intradermal (ID)'::character varying, 'Oral'::character varying, 'Intranasal'::character varying, 'Intravenous (IV)'::character varying]::text[]))),
  body_site character varying CHECK (body_site IS NULL OR (body_site::text = ANY (ARRAY['Left Deltoid'::character varying, 'Right Deltoid'::character varying, 'Left Anterolateral Thigh'::character varying, 'Right Anterolateral Thigh'::character varying, 'Left Upper Arm'::character varying, 'Right Upper Arm'::character varying, 'Left Gluteal'::character varying, 'Right Gluteal'::character varying, 'Oral'::character varying, 'Intranasal'::character varying]::text[]))),
  vaccine_expiration_date date,
  vis_publication_date date,
  vis_given_date date,
  adverse_reaction boolean DEFAULT false,
  adverse_reaction_details text,
  CONSTRAINT vaccinations_pkey PRIMARY KEY (vax_id),
  CONSTRAINT vaccinations_administered_by_fkey FOREIGN KEY (administered_by) REFERENCES public.users(user_id),
  CONSTRAINT vaccinations_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(patient_id),
  CONSTRAINT vaccinations_visit_id_fkey FOREIGN KEY (visit_id) REFERENCES public.medical_visits(visit_id),
  CONSTRAINT vaccinations_deleted_by_fkey FOREIGN KEY (deleted_by) REFERENCES public.users(user_id),
  CONSTRAINT vaccinations_recorded_by_fkey FOREIGN KEY (recorded_by) REFERENCES public.users(user_id)
);